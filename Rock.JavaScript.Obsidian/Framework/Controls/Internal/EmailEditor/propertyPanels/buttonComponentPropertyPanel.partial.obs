<!-- Copyright by the Spark Development Network; Licensed under the Rock Community License -->
<template>
    <ComponentPropertyPanelBase :componentElement="componentElement"
                                :ltr="ltr"
                                title="Button"
                                @clone="$emit('clone')"
                                @complete="$emit('complete')"
                                @delete="$emit('delete')">
        <AccordionGroup>
            <Accordion title="Button Text">
                <TextBox v-model="text"
                         label="Button Text" />

                <HrefPicker v-model="href" />

                <div class="row">
                    <div class="col-sm-8">
                        <FontFamilyPicker v-model="fontFamily" />
                    </div>

                    <div class="col-sm-4 pl-0">
                        <PixelBox v-model="fontSizePx"
                                  label="Font Size" />
                    </div>
                </div>

                <TextFormatPicker v-model:isBold="isBold"
                                  v-model:isUnderlined="isUnderlined"
                                  v-model:isItalicized="isItalicized" />

                <LetterCasePicker v-model="letterCase"
                                  label="" />

                <LineHeightPicker v-model="lineHeight" />

                <ColorPicker v-model.hex="textColor"
                             label="Text Color" />

            </Accordion>

            <Accordion title="Button Styling">
                <div class="row">
                    <div class="col-sm-12">
                        <HorizontalAlignmentPicker v-model="horizontalAlignment"
                                                   label="Alignmment" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <ColorPicker v-model.hex="backgroundColor"
                                     label="Background Color" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <ShorthandPixelBox v-model="borderRadiusPx"
                                           help="Rounded corners may not display correctly in some versions of Outlook or Windows Mail."
                                           label="Border Radius"
                                           topLabel="Top-Left"
                                           bottomLabel="Top-Right"
                                           leftLabel="Bottom-Left"
                                           rightLabel="Bottom-Right" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <ButtonWidthPicker v-model="width" showBlankItem />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <ShorthandPixelBox v-model="marginPx"
                                           label="Margin" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <ShorthandPixelBox v-model="paddingPx"
                                           label="Padding" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <BorderPicker v-model="border"
                                      help="Borders may not display correctly in some versions of Outlook or Windows Mail." />
                    </div>
                </div>
            </Accordion>
        </AccordionGroup>
    </ComponentPropertyPanelBase>
</template>

<style scoped>
:deep(.picker-label) {
    display: none;
}
</style>

<script setup lang="ts">
    import { onMounted, onUnmounted, PropType, ref, watch } from "vue";
    import ComponentPropertyPanelBase from "./componentPropertyPanelBase.partial.obs";
    import Accordion from "../accordion.partial.obs";
    import AccordionGroup from "../accordionGroup.partial.obs";
    import ButtonWidthPicker from "../buttonWidthPicker.partial.obs";
    import BorderPicker from "../borderPicker.partial.obs";
    import ColorPicker from "@Obsidian/Controls/colorPicker.obs";
    import FontFamilyPicker from "../fontFamilyPicker.partial.obs";
    import HrefPicker from "../hrefPicker.partial.obs";
    import LetterCasePicker from "../letterCasePicker.partial.obs";
    import LineHeightPicker from "../lineHeightPicker2.partial.obs";
    import PixelBox from "../pixelBox.partial.obs";
    import TextFormatPicker from "../textFormatPicker2.partial.obs";
    import { BorderModel, ButtonGlobalProps, ButtonWidthModel, HorizontalAlignment, LetterCase, ShorthandModel } from "../types.partial";
    import { createButtonComponentAdapter, createButtonGlobalAdapter, RockCssClassContentEditable } from "../utils.partial";
    import TextBox from "@Obsidian/Controls/textBox.obs";
    import ShorthandPixelBox from "../shorthandPixelBox.partial.obs";
    import HorizontalAlignmentPicker from "../horizontalAlignmentPicker.partial.obs";

    const props = defineProps({
        componentElement: {
            type: Object as PropType<HTMLElement>,
            required: true
        },

        ltr: {
            type: Boolean as PropType<boolean>,
            default: false
        },

        buttonGlobalProps: {
            type: Object as PropType<ButtonGlobalProps>,
            required: true
        }
    });

    defineEmits<{
        (e: "clone"): void;
        (e: "complete"): void;
        (e: "delete"): void;
        (e: "migrate", value: Element): void;
    }>();

    // #region Values

    const buttonComponentAdapter = createButtonComponentAdapter();
    const buttonGlobalAdapter = createButtonGlobalAdapter();
    const href = ref<string>("");
    const borderRadiusPx = ref<ShorthandModel<number | null> | null>(null);
    const horizontalAlignment = ref<HorizontalAlignment | "">("");
    const marginPx = ref<ShorthandModel<number | null> | null>(null);
    const paddingPx = ref<ShorthandModel<number | null> | null>(null);
    const width = ref<ButtonWidthModel | null>(null);
    const text = ref<string>("");
    const backgroundColor = ref<string>("");
    const isBold = ref<boolean | null>(null);
    const isItalicized = ref<boolean | null>(null);
    const isUnderlined = ref<boolean | null>(null);
    const fontFamily = ref<string | null>(null);
    const fontSizePx = ref<number | null>(null);
    const letterCase = ref<LetterCase | null>(null);
    const lineHeight = ref<number | null>(null);
    const border = ref<BorderModel | null>(null);
    const textColor = ref<string>("");

    // Read the current props into the refs.
    readLocalProps();

    // #endregion Values

    // #region Functions

    function writeLocalProps(): void {
        buttonComponentAdapter.writeLocalProps(props.componentElement, {
            backgroundColor: backgroundColor.value || null,
            border: border.value,
            borderRadiusPx: borderRadiusPx.value,
            href: href.value,
            horizontalAlignment: horizontalAlignment.value || null,
            isBold: isBold.value,
            isItalicized: isItalicized.value,
            isUnderlined: isUnderlined.value,
            fontFamily: fontFamily.value,
            fontSizePx: fontSizePx.value,
            letterCase: letterCase.value,
            lineHeight: lineHeight.value,
            marginPx: marginPx.value,
            paddingPx: paddingPx.value,
            text: text.value,
            textColor: textColor.value || null,
            width: width.value
        });

        // Make sure to re-run any global prop overrides
        // just in case local props were removed and there are global props to apply.
        buttonGlobalAdapter.writeGlobalProps(props.componentElement.ownerDocument, props.buttonGlobalProps);
    }

    function readLocalProps(): void {
        const localProps = buttonComponentAdapter.readLocalProps(props.componentElement);

        href.value = localProps.href;
        borderRadiusPx.value = localProps.borderRadiusPx;
        horizontalAlignment.value = localProps.horizontalAlignment ?? "";
        marginPx.value = localProps.marginPx;
        paddingPx.value = localProps.paddingPx;
        width.value = localProps.width;
        text.value = localProps.text;
        backgroundColor.value = localProps.backgroundColor ?? "";
        isBold.value = localProps.isBold;
        isItalicized.value = localProps.isItalicized;
        isUnderlined.value = localProps.isUnderlined;
        fontFamily.value = localProps.fontFamily;
        fontSizePx.value = localProps.fontSizePx;
        letterCase.value = localProps.letterCase;
        lineHeight.value = localProps.lineHeight;
        border.value = localProps.border;
        textColor.value = localProps.textColor ?? "";
    }

    function registerTextInputListener(): void {
        const component = props.componentElement.closest(".component[data-state='component']");
        if (component?.parentElement && component.parentElement.querySelectorAll(`.${RockCssClassContentEditable},[contenteditable="true"]`).length) {
            props.componentElement.addEventListener("input", onInput);
        }
    }

    // #endregion Functions

    // #region Event Handlers

    function onInput(): void {
        const { text: enteredText } = buttonComponentAdapter.readLocalProps(props.componentElement);
        text.value = enteredText;
    }

    // #endregion Event Handlers

    // #region Watchers

    watch(text, (newValue) => {
        const { text: currentText } = buttonComponentAdapter.readLocalProps(props.componentElement);

        if (currentText !== newValue) {
            writeLocalProps();
        }
    });

    watch(backgroundColor, (newVal, oldVal) => {
        // If there was no border color previously
        // or it was previously the same as the background color,
        // update it to match the new background color.
        if (!border.value?.color ||
            (oldVal === border.value.color.top
                && oldVal === border.value.color.left
                && oldVal === border.value.color.right
                && oldVal === border.value.color.bottom)) {
            border.value = {
                style: border.value?.style ?? null,
                widthPx: border.value?.widthPx ?? null,
                color: {
                    top: newVal,
                    right: newVal,
                    bottom: newVal,
                    left: newVal
                }
            };
        }

        writeLocalProps();
    });

    watch([
        //backgroundColor, handled separately to keep border color in sync
        border,
        borderRadiusPx,
        href,
        horizontalAlignment,
        isBold,
        isItalicized,
        isUnderlined,
        fontFamily,
        fontSizePx,
        letterCase,
        lineHeight,
        marginPx,
        paddingPx,
        textColor,
        width
    ], () => {
        writeLocalProps();
    });

    watch(() => props.componentElement, (newElement, oldElement) => {
        if (oldElement) {
            oldElement.removeEventListener("input", onInput);
        }

        registerTextInputListener();
        readLocalProps();
    });

    // #endregion Watchers

    // #region Hooks

    onMounted(() => {
        registerTextInputListener();
    });

    onUnmounted(() => {
        props.componentElement.removeEventListener("input", onInput);
    });

    // #endregion Hooks
</script>
