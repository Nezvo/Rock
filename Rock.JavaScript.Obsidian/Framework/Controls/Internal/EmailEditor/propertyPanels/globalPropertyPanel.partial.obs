<!-- Copyright by the Spark Development Network; Licensed under the Rock Community License -->
<template>
    <FlatPanel :hasPaddedBody="false"
               title="Styles">
        <AccordionGroup>
            <Accordion title="Body Settings">
                <slot name="bodySettingsPrepend"></slot>

                <RangeSliderProperty label="Body Width"
                                     :min="480"
                                     :max="900"
                                     :showValueBar="true"
                                     :valueProvider="getGlobalBodyWidthProvider(document)"
                                     valueSuffix="px" />

                <ColorPickerProperty label="Body Color"
                                     :valueProvider="getGlobalBodyBackgroundColorProvider(document)" />

                <DropDownListProperty label="Body Alignment"
                                      :items="[
                                          {
                                              text: 'Left',
                                              value: 'left'
                                          },
                                          {
                                              text: 'Center',
                                              value: 'center'
                                          },
                                          {
                                              text: 'Right',
                                              value: 'right'
                                          }
                                      ]"
                                      :showBlankItem="false"
                                      :valueProvider="getGlobalBodyAlignmentProvider(document)" />

                <BorderPropertyGroup :element="document.body"
                                     :styleSheetMode="{
                                         styleCssClass: RockStylesCssClass,
                                         rulesetCssSelector: GlobalStylesCssSelectors.bodyBorderStyling
                                     }" />

                <PaddingProperty :element="document.body"
                                 label="Margin"
                                 :styleSheetMode="{
                                     styleCssClass: RockStylesCssClass,
                                     rulesetCssSelector: GlobalStylesCssSelectors.bodyMargin
                                 }" />

                <PaddingProperty :element="document.body"
                                 label="Padding"
                                 :styleSheetMode="{
                                     styleCssClass: RockStylesCssClass,
                                     rulesetCssSelector: GlobalStylesCssSelectors.bodyPadding
                                 }" />
            </Accordion>

            <Accordion title="Background Settings">

                <ColorPickerProperty label="Background Color"
                                     :valueProvider="getGlobalBackgroundColorProvider(document)" />

                <BackgroundImagePropertyGroup v-if="emailWrapperElement"
                                              :element="emailWrapperElement" />
            </Accordion>

            <Accordion title="Text Styling" removeBottomPadding removeTopPadding>
                <AccordionGroup>
                    <Accordion accordionType="link"
                               title="Global">
                        <FontPropertyGroup :element="document.body"
                                           :styleSheetMode="{
                                               styleCssClass: RockStylesCssClass,
                                               rulesetCssSelector: `.${GlobalCssClasses.fontGlobal}`
                                           }" />
                    </Accordion>

                    <Accordion accordionType="link"
                               title="Heading 1">
                        <FontPropertyGroup :element="document.body"
                                           :styleSheetMode="{
                                               styleCssClass: RockStylesCssClass,
                                               rulesetCssSelector: `.${GlobalCssClasses.fontHeading1}`
                                           }" />

                        <PaddingProperty label="Margin"
                                         :element="document.body"
                                         :styleSheetMode="{
                                             styleCssClass: RockStylesCssClass,
                                             rulesetCssSelector: `.${GlobalCssClasses.marginHeading1}`
                                         }" />

                        <PaddingProperty label="Padding"
                                         :element="document.body"
                                         :styleSheetMode="{
                                             styleCssClass: RockStylesCssClass,
                                             rulesetCssSelector: `.${GlobalCssClasses.paddingHeading1}`
                                         }" />

                        <BorderPropertyGroup :element="document.body"
                                             :styleSheetMode="{
                                                 styleCssClass: RockStylesCssClass,
                                                 rulesetCssSelector: `.${GlobalCssClasses.borderHeading1}`
                                             }" />
                    </Accordion>

                    <Accordion accordionType="link"
                               title="Heading 2">
                        <FontPropertyGroup :element="document.body"
                                           :styleSheetMode="{
                                               styleCssClass: RockStylesCssClass,
                                               rulesetCssSelector: `.${GlobalCssClasses.fontHeading2}`
                                           }" />

                        <PaddingProperty label="Margin"
                                         :element="document.body"
                                         :styleSheetMode="{
                                             styleCssClass: RockStylesCssClass,
                                             rulesetCssSelector: `.${GlobalCssClasses.marginHeading2}`
                                         }" />

                        <PaddingProperty label="Padding"
                                         :element="document.body"
                                         :styleSheetMode="{
                                             styleCssClass: RockStylesCssClass,
                                             rulesetCssSelector: `.${GlobalCssClasses.paddingHeading2}`
                                         }" />

                        <BorderPropertyGroup :element="document.body"
                                             :styleSheetMode="{
                                                 styleCssClass: RockStylesCssClass,
                                                 rulesetCssSelector: `.${GlobalCssClasses.borderHeading2}`
                                             }" />
                    </Accordion>

                    <Accordion accordionType="link"
                               title="Heading 3">
                        <FontPropertyGroup :element="document.body"
                                           :styleSheetMode="{
                                               styleCssClass: RockStylesCssClass,
                                               rulesetCssSelector: `.${GlobalCssClasses.fontHeading3}`
                                           }" />

                        <PaddingProperty label="Margin"
                                         :element="document.body"
                                         :styleSheetMode="{
                                             styleCssClass: RockStylesCssClass,
                                             rulesetCssSelector: `.${GlobalCssClasses.marginHeading3}`
                                         }" />

                        <PaddingProperty label="Padding"
                                         :element="document.body"
                                         :styleSheetMode="{
                                             styleCssClass: RockStylesCssClass,
                                             rulesetCssSelector: `.${GlobalCssClasses.paddingHeading3}`
                                         }" />

                        <BorderPropertyGroup :element="document.body"
                                             :styleSheetMode="{
                                                 styleCssClass: RockStylesCssClass,
                                                 rulesetCssSelector: `.${GlobalCssClasses.borderHeading3}`
                                             }" />
                    </Accordion>

                    <Accordion accordionType="link"
                               title="Paragraph">
                        <FontPropertyGroup :element="document.body"
                                           :styleSheetMode="{
                                               styleCssClass: RockStylesCssClass,
                                               rulesetCssSelector: `.${GlobalCssClasses.fontParagraph}`
                                           }" />

                        <PaddingProperty label="Margin"
                                         :element="document.body"
                                         :styleSheetMode="{
                                             styleCssClass: RockStylesCssClass,
                                             rulesetCssSelector: `.${GlobalCssClasses.marginParagraph}`
                                         }" />
                    </Accordion>
                </AccordionGroup>
            </Accordion>

            <Accordion title="Button Styling">
                <ColorPicker v-model.hex="buttonGlobalBackgroundColorOrEmptyString"
                             label="Background Color" />

                <div class="row">
                    <div class="col-sm-8">
                        <FontFamilyPicker v-model="buttonGlobalFontFamily" />
                    </div>

                    <div class="col-sm-4 pl-0">
                        <PixelBox v-model="buttonGlobalFontSizePx"
                                  label="Font Size" />
                    </div>
                </div>

                <TextFormatPicker v-model:isBold="buttonGlobalIsBold"
                                  v-model:isUnderlined="buttonGlobalIsUnderlined"
                                  v-model:isItalicized="buttonGlobalIsItalicized" />

                <LetterCasePicker v-model="buttonGlobalLetterCase"
                                  label="" />

                <LineHeightPicker v-model="buttonGlobalLineHeight" />

                <ColorPicker v-model.hex="buttonGlobalTextColorOrEmptyString"
                             label="Text Color" />

                <div class="row">
                    <div class="col-sm-12">
                        <BorderPicker v-model="buttonGlobalBorder"
                                      help="Borders may not display correctly in some versions of Outlook or Windows Mail." />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12"><!-- TODO JMH Verify if we should specify "Some versions of..." if testing reveals that some versions do work. -->
                        <ShorthandPixelBox v-model="buttonGlobalBorderRadiusPx"
                                           help="Rounded corners may not display correctly in some versions of Outlook or Windows Mail."
                                           label="Border Radius"
                                           topLabel="Top-Left"
                                           bottomLabel="Top-Right"
                                           leftLabel="Bottom-Left"
                                           rightLabel="Bottom-Right" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <ButtonWidthPicker v-model="buttonGlobalWidth" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <ShorthandPixelBox v-model="buttonGlobalMarginPx"
                                           label="Margin" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <ShorthandPixelBox v-model="buttonGlobalPaddingPx"
                                           label="Padding" />
                    </div>
                </div>
            </Accordion>

            <Accordion title="Divider Styling">
                <div class="row">
                    <div class="col-sm-6">
                        <DividerStyleProperty :element="document.body"
                                              label="Style"
                                              :styleSheetMode="{
                                                styleCssClass: RockStylesCssClass,
                                                rulesetCssSelector: GlobalStylesCssSelectors.dividerStyle
                                            }" />
                    </div>

                    <div class="col-sm-6 pl-0">
                        <DividerThicknessProperty :element="document.body"
                                                  label="Thickness"
                                                  :styleSheetMode="{
                                                    styleCssClass: RockStylesCssClass,
                                                    rulesetCssSelector: GlobalStylesCssSelectors.dividerThickness
                                                }" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-8">
                        <DividerColorProperty :element="document.body"
                                              label="Color"
                                              :styleSheetMode="{
                                                styleCssClass: RockStylesCssClass,
                                                rulesetCssSelector: GlobalStylesCssSelectors.dividerColor
                                            }" />
                    </div>
                </div>

                <RangeSliderProperty label="Divider Width"
                                     :min="5"
                                     :max="100"
                                     :showValueBar="true"
                                     valueSuffix="%"
                                     :valueProvider="getGlobalDividerWidthProvider(document)" />

                <HorizontalAlignmentProperty label="Horizontal Alignment"
                                             :valueProvider="getGlobalDividerHorizontalAlignmentProvider(document)" />

                <PaddingProperty :element="document.body"
                                 label="Margin"
                                 :styleSheetMode="{
                                    styleCssClass: RockStylesCssClass,
                                    rulesetCssSelector: GlobalStylesCssSelectors.dividerMargin
                                }" />
            </Accordion>
        </AccordionGroup>
    </FlatPanel>
</template>

<script setup lang="ts">
    import { computed, PropType, ref, watch } from "vue";
    import Accordion from "../accordion.partial.obs";
    import AccordionGroup from "../accordionGroup.partial.obs";
    import BorderPicker from "../borderPicker.partial.obs";
    import ButtonWidthPicker from "../buttonWidthPicker.partial.obs";
    import FlatPanel from "../flatPanel.partial.obs";
    import FontFamilyPicker from "../fontFamilyPicker.partial.obs";
    import LetterCasePicker from "../letterCasePicker.partial.obs";
    import LineHeightPicker from "../lineHeightPicker2.partial.obs";
    import PixelBox from "../pixelBox.partial.obs";
    import ShorthandPixelBox from "../shorthandPixelBox.partial.obs";
    import TextFormatPicker from "../textFormatPicker2.partial.obs";
    import BackgroundImagePropertyGroup from "../properties/backgroundImagePropertyGroup.partial.obs";
    import BorderPropertyGroup from "../properties/borderPropertyGroup.partial.obs";
    import ColorPickerProperty from "../properties/colorPickerProperty.partial.obs";
    import DividerColorProperty from "../properties/dividerColorProperty.partial.obs";
    import DividerStyleProperty from "../properties/dividerStyleProperty.partial.obs";
    import DividerThicknessProperty from "../properties/dividerThicknessProperty.partial.obs";
    import DropDownListProperty from "../properties/dropDownListProperty.partial.obs";
    import FontPropertyGroup from "../properties/fontPropertyGroup.partial.obs";
    import HorizontalAlignmentProperty from "../properties/horizontalAlignmentProperty.partial.obs";
    import PaddingProperty from "../properties/paddingProperty.partial.obs";
    import RangeSliderProperty from "../properties/rangeSliderProperty.partial.obs";
    import {
    getGlobalBodyAlignmentProvider,
    getGlobalBodyBackgroundColorProvider,
    getGlobalBodyWidthProvider,
    getGlobalBackgroundColorProvider,
    getGlobalDividerWidthProvider,
    getGlobalDividerHorizontalAlignmentProvider
    } from "../providers.partial";
    import {
    EmailWrapperCssClass,
    GlobalCssClasses,
    GlobalStylesCssSelectors,
    RockStylesCssClass
    } from "../utils.partial";
    import ColorPicker from "@Obsidian/Controls/colorPicker.obs";
    import { isHTMLElement } from "@Obsidian/Utility/dom";
    import { BorderModel, ButtonGlobalProps, ButtonWidthModel, LetterCase, ShorthandModel } from "../types.partial";

    const props = defineProps({
    document: {
    type: Object as PropType<Document>,
            required: true
        },

        buttonGlobalProps: {
            type: Object as PropType<ButtonGlobalProps>,
            required: true
        }
    });

    const emit = defineEmits<{
        (e: "update:buttonGlobalProps", value: ButtonGlobalProps): void;
    }>();

    // #region Values

    const buttonGlobalBackgroundColorOrEmptyString = ref<string>(props.buttonGlobalProps.backgroundColor ?? "");
    const buttonGlobalFontFamily = ref<string | null>(props.buttonGlobalProps.fontFamily);
    const buttonGlobalFontSizePx = ref<number | null>(props.buttonGlobalProps.fontSizePx);
    const buttonGlobalIsBold = ref<boolean | null>(props.buttonGlobalProps.isBold);
    const buttonGlobalIsUnderlined = ref<boolean | null>(props.buttonGlobalProps.isUnderlined);
    const buttonGlobalIsItalicized = ref<boolean | null>(props.buttonGlobalProps.isItalicized);
    const buttonGlobalLetterCase = ref<LetterCase | null>(props.buttonGlobalProps.letterCase);
    const buttonGlobalLineHeight = ref<number | null>(props.buttonGlobalProps.lineHeight);
    const buttonGlobalTextColorOrEmptyString = ref<string>(props.buttonGlobalProps.textColor ?? "");
    const buttonGlobalBorder = ref<BorderModel | null>(props.buttonGlobalProps.border);
    const buttonGlobalBorderRadiusPx = ref<ShorthandModel<number | null> | null>(props.buttonGlobalProps.borderRadiusPx);
    const buttonGlobalWidth = ref<ButtonWidthModel | null>(props.buttonGlobalProps.width);
    const buttonGlobalMarginPx = ref<ShorthandModel<number | null> | null>(props.buttonGlobalProps.marginPx);
    const buttonGlobalPaddingPx = ref<ShorthandModel<number | null> | null>(props.buttonGlobalProps.paddingPx);

    // #endregion Values

    // #region Computed Values

    const emailWrapperElement = computed<HTMLElement | null>(() => {
        const el = props.document.querySelector(`.${EmailWrapperCssClass}`);

        if (isHTMLElement(el)) {
            return el;
        }
        else {
            return null;
        }
    });

    // #endregion Computed Values

    // #region Functions

    function emitUpdateGlobalButtonProps(): void {
        emit("update:buttonGlobalProps", {
            backgroundColor: buttonGlobalBackgroundColorOrEmptyString.value,
            fontFamily: buttonGlobalFontFamily.value,
            fontSizePx: buttonGlobalFontSizePx.value,
            isBold: buttonGlobalIsBold.value,
            isUnderlined: buttonGlobalIsUnderlined.value,
            isItalicized: buttonGlobalIsItalicized.value,
            letterCase: buttonGlobalLetterCase.value,
            lineHeight: buttonGlobalLineHeight.value,
            textColor: buttonGlobalTextColorOrEmptyString.value,
            border: buttonGlobalBorder.value,
            borderRadiusPx: buttonGlobalBorderRadiusPx.value,
            width: buttonGlobalWidth.value,
            marginPx: buttonGlobalMarginPx.value,
            paddingPx: buttonGlobalPaddingPx.value
        });
    }

    // #endregion Functions

    // #region Watchers

    watch(buttonGlobalBackgroundColorOrEmptyString, (newVal, oldVal) => {
        // If the border color was previously the same as the background color,
        // update it to match the new background color.
        if (buttonGlobalBorder.value?.color &&
            oldVal === buttonGlobalBorder.value.color.top
            && oldVal === buttonGlobalBorder.value.color.left
            && oldVal === buttonGlobalBorder.value.color.right
            && oldVal === buttonGlobalBorder.value.color.bottom) {
            buttonGlobalBorder.value = {
                style: buttonGlobalBorder.value?.style,
                widthPx: buttonGlobalBorder.value?.widthPx,
                color: {
                    top: newVal,
                    right: newVal,
                    bottom: newVal,
                    left: newVal
                }
            };
        }

        emitUpdateGlobalButtonProps();
    });

    watch([
        //globalButtonBackgroundColorOrEmptyString, Separate watcher for this to keep the border color logic isolated.
        buttonGlobalFontFamily,
        buttonGlobalFontSizePx,
        buttonGlobalIsBold,
        buttonGlobalIsUnderlined,
        buttonGlobalIsItalicized,
        buttonGlobalLetterCase,
        buttonGlobalLineHeight,
        buttonGlobalTextColorOrEmptyString,
        buttonGlobalBorder,
        buttonGlobalBorderRadiusPx,
        buttonGlobalWidth,
        buttonGlobalMarginPx,
        buttonGlobalPaddingPx
    ], () => {
        emitUpdateGlobalButtonProps();
    });

    watch(() => props.buttonGlobalProps, (newVal) => {
        buttonGlobalBackgroundColorOrEmptyString.value = newVal.backgroundColor ?? "";
        buttonGlobalFontFamily.value = newVal.fontFamily;
        buttonGlobalFontSizePx.value = newVal.fontSizePx;
        buttonGlobalIsBold.value = newVal.isBold;
        buttonGlobalIsUnderlined.value = newVal.isUnderlined;
        buttonGlobalIsItalicized.value = newVal.isItalicized;
        buttonGlobalLetterCase.value = newVal.letterCase;
        buttonGlobalLineHeight.value = newVal.lineHeight;
        buttonGlobalTextColorOrEmptyString.value = newVal.textColor ?? "";
        buttonGlobalBorder.value = newVal.border;
        buttonGlobalBorderRadiusPx.value = newVal.borderRadiusPx;
        buttonGlobalWidth.value = newVal.width;
        buttonGlobalMarginPx.value = newVal.marginPx;
        buttonGlobalPaddingPx.value = newVal.paddingPx;
    });

    // #endregion Watchers
</script>
