<!-- Copyright by the Spark Development Network; Licensed under the Rock Community License -->
<template>
    <ComponentPropertyPanelBase :componentElement="componentElement"
                                :ltr="ltr"
                                title="RSVP"
                                @clone="$emit('clone')"
                                @complete="$emit('complete')"
                                @delete="$emit('delete')"
                                @migrate="$emit('migrate', $event)">
        <AccordionGroup>
            <Accordion title="Settings">
                <div class="row">
                    <div class="col-sm-12">
                        <GroupPicker v-model="selectedGroupListItemBag"
                                     label="RSVP Group"
                                     :limitToRSVPEnabled="true"
                                     @update:modelValue="areRsvpRecipientsRegistered = false" />
                    </div>
                </div>

                <TransitionVerticalCollapse>
                    <div v-if="selectedGroupListItemBag && occurrenceItems?.length" class="row">
                        <div class="col-sm-12">
                            <DropDownList v-model="rsvpOccurrenceValue"
                                          label="Occurrence"
                                          :items="occurrenceItems"
                                          @update:modelValue="areRsvpRecipientsRegistered = false" />
                        </div>
                    </div>
                </TransitionVerticalCollapse>

                <TransitionVerticalCollapse>
                    <div v-if="rsvpOccurrenceValue">
                        <div class="row">
                            <div class="col-sm-12">
                                <RockButton btnSize="xs"
                                            :disabled="isCreatingOccurrence || areRsvpRecipientsRegistering || areRsvpRecipientsRegistered"
                                            @click="onRegisterRecipientsClicked">
                                    <i class="ti ti-user-check"></i> {{ areRsvpRecipientsRegistering ? 'Registering...' : areRsvpRecipientsRegistered ? 'Recipients Registered!' : 'Register Recipients' }}
                                </RockButton>
                            </div>
                        </div>
                    </div>
                </TransitionVerticalCollapse>
            </Accordion>

            <Accordion title="Block Styling">
                <ShorthandPixelBox v-model="blockPaddingPx"
                                   label="Padding" />

                <HorizontalAlignmentPicker v-model="blockHorizontalAlignment"
                                           label="Horizontal Alignmment" />
            </Accordion>

            <Accordion title="Buttons">
                <div class="row">
                    <div class="col-sm-8">
                        <FontFamilyPicker v-model="fontFamily" />
                    </div>

                    <div class="col-sm-4 pl-0">
                        <PixelBox v-model="fontSizePx"
                                  label="Font Size" />
                    </div>
                </div>

                <TextFormatPicker v-model:isBold="isBold"
                                  v-model:isUnderlined="isUnderlined"
                                  v-model:isItalicized="isItalicized" />

                <LetterCasePicker v-model="letterCase"
                                  label="" />

                <LineHeightPicker v-model="lineHeight" />

                <div class="row">
                    <div class="col-sm-12">
                        <ShorthandPixelBox v-model="buttonPaddingPx"
                                           label="Button Padding" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <ShorthandPixelBox v-model="borderRadiusPx"
                                           help="Rounded corners may not display correctly in some versions of Outlook or Windows Mail."
                                           label="Corner Radius"
                                           topLabel="Top-Left"
                                           bottomLabel="Top-Right"
                                           leftLabel="Bottom-Left"
                                           rightLabel="Bottom-Right" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <RockLabel class="section-label">Accept Button</RockLabel>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <TextBox v-model="acceptText"
                                 label="Label" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <ButtonWidthPicker v-model="acceptWidth" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-8">
                        <ColorPicker v-model.hex="acceptButtonBackgroundColor"
                                     label="Background Color" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-8">
                        <ColorPicker v-model.hex="acceptButtonColor"
                                     label="Text Color" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <RockLabel class="section-label">Decline Button</RockLabel>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <Switch v-model="isDeclineButtonShown"
                                label="Show" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <TextBox v-model="declineText"
                                 label="Label" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <ButtonWidthPicker v-model="declineWidth" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-8">
                        <ColorPicker v-model.hex="declineButtonBackgroundColor"
                                     label="Background Color" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-8">
                        <ColorPicker v-model.hex="declineButtonColor"
                                     label="Text Color" />
                    </div>
                </div>
            </Accordion>
        </AccordionGroup>
    </ComponentPropertyPanelBase>
</template>

<style scoped>
:deep(.colorpicker-element) {
    width: auto;
}

.section-label {
    border-bottom: 1px solid var(--color-interface-soft);
    width: 100%;
    padding-bottom: var(--spacing-xsmall);
    font-size: var(--font-size-regular);
}
</style>

<script setup lang="ts">
    import { onMounted, onUnmounted, PropType, ref, watch } from "vue";
    import ComponentPropertyPanelBase from "./componentPropertyPanelBase.partial.obs";
    import Accordion from "../accordion.partial.obs";
    import AccordionGroup from "../accordionGroup.partial.obs";
    import { useApi } from "../api";
    //import { createButtonWidthValuesProvider } from "../providers.partial";
    import { createRsvpComponentAdapter } from "../utils.partial";
    import DropDownList from "@Obsidian/Controls/dropDownList.obs";
    import GroupPicker from "@Obsidian/Controls/groupPicker.obs";
    import RockButton from "@Obsidian/Controls/rockButton.obs";
    import RockLabel from "@Obsidian/Controls/rockLabel.obs";
    import TransitionVerticalCollapse from "@Obsidian/Controls/transitionVerticalCollapse.obs";
    import { toGuidOrNull } from "@Obsidian/Utility/guid";
    import { toNumberOrNull } from "@Obsidian/Utility/numberUtils";
    import { isNullish } from "@Obsidian/Utility/util";
    import { EmailEditorAttendanceOccurrenceBag } from "@Obsidian/ViewModels/Rest/Controls/emailEditorAttendanceOccurrenceBag";
    import { EmailEditorRegisterRsvpRecipientsOptionsBag } from "@Obsidian/ViewModels/Rest/Controls/emailEditorRegisterRsvpRecipientsOptionsBag";
    import { ListItemBag } from "@Obsidian/ViewModels/Utility/listItemBag";
    import ShorthandPixelBox from "../shorthandPixelBox.partial.obs";
    import HorizontalAlignmentPicker from "../horizontalAlignmentPicker.partial.obs";
    import FontFamilyPicker from "../fontFamilyPicker.partial.obs";
    import PixelBox from "../pixelBox.partial.obs";
    import TextFormatPicker from "../textFormatPicker2.partial.obs";
    import LetterCasePicker from "../letterCasePicker.partial.obs";
    import LineHeightPicker from "../lineHeightPicker2.partial.obs";
    import ColorPicker from "@Obsidian/Controls/colorPicker.obs";
    import TextBox from "@Obsidian/Controls/textBox.obs";
    import { ButtonWidthModel, HorizontalAlignment, LetterCase, ShorthandModel } from "../types.partial";
    import { Guid } from "@Obsidian/Types";
    import ButtonWidthPicker from "../buttonWidthPicker.partial.obs";
    import Switch from "@Obsidian/Controls/switch.obs";

    const props = defineProps({
        componentElement: {
            type: Object as PropType<HTMLElement>,
            required: true
        },

        ltr: {
            type: Boolean as PropType<boolean>,
            default: false
        },

        recipientPersonIds: {
            type: Object as PropType<number[] | null | undefined>,
            required: true
        }
    });

    defineEmits<{
        (e: "clone"): void;
        (e: "complete"): void;
        (e: "delete"): void;
        (e: "migrate", value: Element): void;
    }>();

    const rsvpComponentAdapter = createRsvpComponentAdapter();
    const api = useApi();

    // #region Values

    // State
    const blockPaddingPx = ref<ShorthandModel<number | null> | null>(null);
    const blockHorizontalAlignment = ref<HorizontalAlignment | "">("");
    const fontFamily = ref<string | null>(null);
    const fontSizePx = ref<number | null>(null);
    const isBold = ref<boolean | null>(null);
    const isUnderlined = ref<boolean | null>(null);
    const isItalicized = ref<boolean | null>(null);
    const letterCase = ref<LetterCase | null>(null);
    const lineHeight = ref<number | null>(null);
    const buttonPaddingPx = ref<ShorthandModel<number | null> | null>(null);
    const borderRadiusPx = ref<ShorthandModel<number | null> | null>(null);
    const acceptText = ref<string>("");
    const acceptWidth = ref<ButtonWidthModel | null>(null);
    const acceptButtonBackgroundColor = ref<string>("");
    const acceptButtonColor = ref<string>("");
    const isDeclineButtonShown = ref<boolean>(true);
    const declineText = ref<string>("");
    const declineWidth = ref<ButtonWidthModel | null>(null);
    const declineButtonBackgroundColor = ref<string>("");
    const declineButtonColor = ref<string>("");
    const rsvpGroupGuid = ref<Guid | null>(null);
    const rsvpOccurrenceValue = ref<string>("");

    // UI state
    const areRsvpRecipientsRegistering = ref<boolean>(false);
    const areRsvpRecipientsRegistered = ref<boolean>(false);
    const isCreatingOccurrence = ref<boolean>(false);

    const occurrenceItems = ref<ListItemBag[] | undefined>(undefined);
    const selectedGroupListItemBag = ref<ListItemBag | null | undefined>();

    // Read the current props into the refs.
    readLocalProps();

    // #endregion Values

    // #region Functions

    function writeLocalProps(): void {
        rsvpComponentAdapter.writeLocalProps(props.componentElement, {
            acceptBackgroundColor: acceptButtonBackgroundColor.value || null,
            acceptTextColor: acceptButtonColor.value || null,
            blockHorizontalAlignment: blockHorizontalAlignment.value || null,
            blockPaddingPx: blockPaddingPx.value,
            buttonBorderRadiusPx: borderRadiusPx.value,
            fontFamily: fontFamily.value,
            fontSizePx: fontSizePx.value,
            isBold: isBold.value,
            isUnderlined: isUnderlined.value,
            isItalicized: isItalicized.value,
            letterCase: letterCase.value,
            lineHeight: lineHeight.value,
            buttonPaddingPx: buttonPaddingPx.value,
            acceptText: acceptText.value,
            acceptWidth: acceptWidth.value,
            declineText: declineText.value,
            declineWidth: declineWidth.value,
            declineBackgroundColor: declineButtonBackgroundColor.value || null,
            declineTextColor: declineButtonColor.value || null,
            isDeclineHidden: !isDeclineButtonShown.value,
            rsvpGroupGuid: rsvpGroupGuid.value,
            rsvpOccurrenceValue: rsvpOccurrenceValue.value || null
        });
    }

    function readLocalProps(): void {
        const localProps = rsvpComponentAdapter.readLocalProps(props.componentElement);

        acceptButtonBackgroundColor.value = localProps.acceptBackgroundColor ?? "";
        acceptButtonColor.value = localProps.acceptTextColor ?? "";
        blockHorizontalAlignment.value = localProps.blockHorizontalAlignment ?? "";
        blockPaddingPx.value = localProps.blockPaddingPx;
        borderRadiusPx.value = localProps.buttonBorderRadiusPx;
        fontFamily.value = localProps.fontFamily;
        fontSizePx.value = localProps.fontSizePx;
        isBold.value = localProps.isBold;
        isUnderlined.value = localProps.isUnderlined;
        isItalicized.value = localProps.isItalicized;
        letterCase.value = localProps.letterCase;
        lineHeight.value = localProps.lineHeight;
        buttonPaddingPx.value = localProps.buttonPaddingPx;
        acceptText.value = localProps.acceptText ?? "";
        acceptWidth.value = localProps.acceptWidth;
        declineText.value = localProps.declineText ?? "";
        declineWidth.value = localProps.declineWidth;
        declineButtonBackgroundColor.value = localProps.declineBackgroundColor ?? "";
        declineButtonColor.value = localProps.declineTextColor ?? "";
        isDeclineButtonShown.value = !localProps.isDeclineHidden;
        rsvpGroupGuid.value = localProps.rsvpGroupGuid;
        rsvpOccurrenceValue.value = localProps.rsvpOccurrenceValue ?? "";
    }

    function parseFutureOccurrenceData(value: string): EmailEditorAttendanceOccurrenceBag {
        const [id, groupId, locationId, scheduleId, occurrenceDate] = (value || "").split("|");

        return {
            occurrenceId: toNumberOrNull(id) ?? 0,
            groupId: toNumberOrNull(groupId),
            locationId: toNumberOrNull(locationId),
            scheduleId: toNumberOrNull(scheduleId),
            occurrenceDate
        };
    }

    function serializeAttendanceOccurrence(value: EmailEditorAttendanceOccurrenceBag): string {
        return `${value.occurrenceId}|${value.groupId ?? ""}|${value.locationId ?? ""}|${value.scheduleId ?? ""}|${value.occurrenceDate ?? ""}`;
    }

    async function getGroupListItemBagOrNull(): Promise<ListItemBag | null> {
        const groupGuid = rsvpGroupGuid.value;

        if (!groupGuid) {
            return null;
        }

        const result = await api.getGroup({
            groupGuid
        });

        if (!result.isSuccess || !result.data) {
            console.error(result.errorMessage ?? "An error occurred while getting the group.");
            return null;
        }

        return result.data;
    }

    async function loadOccurrenceItems(): Promise<void> {
        if (rsvpGroupGuid.value) {
            // Get the future group occurrences.
            const result = await api.getFutureAttendanceOccurrences({
                groupGuid: rsvpGroupGuid.value
            });

            if (result?.isSuccess && result.data) {
                occurrenceItems.value = result.data;
            }
            else {
                console.error(result.errorMessage ?? "An error occurred while getting future group occurrences.");
                occurrenceItems.value = undefined;
            }
        }
    }

    // #endregion Functions

    // #region Event Handlers

    function onAcceptInput(): void {
        const { acceptText: enteredText } = rsvpComponentAdapter.readLocalProps(props.componentElement);
        acceptText.value = enteredText;
    }

    function onDeclineInput(): void {
        const { declineText: enteredText } = rsvpComponentAdapter.readLocalProps(props.componentElement);
        declineText.value = enteredText;
    }

    async function onRegisterRecipientsClicked(): Promise<void> {
        areRsvpRecipientsRegistering.value = true;
        try {
            const data = parseFutureOccurrenceData(rsvpOccurrenceValue.value);

            if (!data.occurrenceId) {
                console.error("An occurrence needs to be selected before registering recipients.");
                return;
            }

            const bag: EmailEditorRegisterRsvpRecipientsOptionsBag = {
                occurrenceId: data.occurrenceId,
                personIds: props.recipientPersonIds
            };

            const result = await api.registerRsvpRecipients(bag);

            if (result?.isSuccess) {
                areRsvpRecipientsRegistered.value = true;
            }
            else {
                areRsvpRecipientsRegistered.value = true;
                console.error(result?.errorMessage ?? "An error occurred while registering recipients.");
            }
        }
        finally {
            areRsvpRecipientsRegistering.value = false;
        }
    }

    // #endregion Event Handlers

    // #region Watchers

    watch(selectedGroupListItemBag, async () => {
        rsvpGroupGuid.value = toGuidOrNull(selectedGroupListItemBag.value?.value);
    });

    watch(rsvpGroupGuid, async () => {
        // Cannot clear the occurrence id here because this handler is invoked even when the control is initialized,
        // and it clears out the occurrence id on load.
        await loadOccurrenceItems();
        writeLocalProps();
    });

    watch(rsvpOccurrenceValue, async (serializedOccurrence) => {
        const data = parseFutureOccurrenceData(serializedOccurrence);

        if (data.occurrenceId === 0 && !isNullish(data.groupId)) {
            isCreatingOccurrence.value = true;
            try {
                // Create new occurrence.
                const result = await api.createAttendanceOccurrence({
                    groupId: data.groupId,
                    locationId: data.locationId,
                    occurrenceDate: data.occurrenceDate,
                    scheduleId: data.scheduleId
                });

                if (result?.isSuccess && result.data) {
                    serializedOccurrence = serializeAttendanceOccurrence(result.data);
                }
                else {
                    console.error(result?.errorMessage ?? "An error occurred while creating the attendance occurrence.");
                }
            }
            finally {
                isCreatingOccurrence.value = false;
            }
        }

        writeLocalProps();
    });

    watch(acceptText, (newValue) => {
        const { acceptText: currentText } = rsvpComponentAdapter.readLocalProps(props.componentElement);

        if (currentText !== newValue) {
            writeLocalProps();
        }
    });

    watch(declineText, (newValue) => {
        const { declineText: currentText } = rsvpComponentAdapter.readLocalProps(props.componentElement);

        if (currentText !== newValue) {
            writeLocalProps();
        }
    });

    watch([
        blockPaddingPx,
        blockHorizontalAlignment,
        fontFamily,
        fontSizePx,
        isBold,
        isUnderlined,
        isItalicized,
        letterCase,
        lineHeight,
        buttonPaddingPx,
        borderRadiusPx,
        // acceptText, Handled separately above
        acceptWidth,
        acceptButtonBackgroundColor,
        acceptButtonColor,
        isDeclineButtonShown,
        // declineText, Handled separately above
        declineWidth,
        declineButtonBackgroundColor,
        declineButtonColor,
        // rsvpGroupGuid, Handled separately above
        // rsvpOccurrenceValue Handled separately above
    ], () => {
        writeLocalProps();
    });

    watch(() => props.componentElement, async (newElement, oldElement) => {
        if (oldElement) {
            oldElement.querySelector(".rsvp-accept-link")?.removeEventListener("input", onAcceptInput);
            oldElement.querySelector(".rsvp-decline-link")?.removeEventListener("input", onDeclineInput);
        }

        newElement.querySelector(".rsvp-accept-link")?.addEventListener("input", onAcceptInput);
        newElement.querySelector(".rsvp-decline-link")?.addEventListener("input", onDeclineInput);

        readLocalProps();

        selectedGroupListItemBag.value = await getGroupListItemBagOrNull();
    });

    // #endregion Watchers

    // #region Hooks

    onMounted(async () => {
        // Watch for changes to the RSVP links since they are contenteditable.
        props.componentElement.querySelector(".rsvp-accept-link")?.addEventListener("input", onAcceptInput);
        props.componentElement.querySelector(".rsvp-decline-link")?.addEventListener("input", onDeclineInput);

        // Load occurrence items right away the picker can be populated and not clear out the selection.
        await loadOccurrenceItems();
        selectedGroupListItemBag.value = await getGroupListItemBagOrNull();
    });

    onUnmounted(() => {
        props.componentElement.querySelector(".rsvp-accept-link")?.removeEventListener("input", onAcceptInput);
        props.componentElement.querySelector(".rsvp-decline-link")?.removeEventListener("input", onDeclineInput);
    });

    // #endregion Hooks
</script>
