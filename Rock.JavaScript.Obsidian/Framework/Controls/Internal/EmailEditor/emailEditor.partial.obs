<!-- Copyright by the Spark Development Network; Licensed under the Rock Community License -->
<template>
    <div class="email-editor-wrapper styled-scroll">
        <div class="email-editor">
            <SidePanel v-if="ltr"
                       v-model:buttonGlobalProps="buttonGlobalProps"
                       v-model:selectedComponentElement="selectedComponentElement"
                       :emailDocument="emailDocument"
                       :imageComponentBinaryFileTypeGuid="imageComponentBinaryFileTypeGuid"
                       :ltr="ltr"
                       :mergeFields="mergeFields"
                       :recipientPersonIds="recipientPersonIds"
                       :shortLinkCheckToken="shortLinkCheckToken"
                       :shortLinkGetPageId="shortLinkGetPageId"
                       :shortLinkSites="shortLinkSites"
                       :shortLinkTokenMinLength="shortLinkTokenMinLength"
                       :usageType="usageType"
                       :videoProviderNames="videoProviderNames"
                       @cloneComponent="onCloneComponent"
                       @completeComponent="onCompleteComponent"
                       @componentTypeDragStart="onComponentTypeDragStart"
                       @componentTypeDragEnd="onComponentTypeDragEnd"
                       @deleteComponent="onDeleteComponent"
                       @replaceComponent="onReplaceComponent">
                <template v-if="$slots.bodySettingsPrepend" #bodySettingsPrepend>
                    <slot name="bodySettingsPrepend"></slot>
                </template>
            </SidePanel>

            <div class="email-designer-container">
                <EmailDesigner v-model:selectedComponentElement="selectedComponentElement"
                               :html="html"
                               :cloneComponentRequest="cloneComponentRequest"
                               :completeComponentRequest="completeComponentRequest"
                               :deleteComponentRequest="deleteComponentRequest"
                               :componentTypeDragStartRequest="componentTypeDragStartRequest"
                               :componentTypeDragEndRequest="componentTypeDragEndRequest"
                               :getHtmlRequest="getHtmlRequest"
                               :replaceComponentRequest="replaceComponentRequest"
                               :isDisabled="disabled"
                               @emailDocumentUpdated="onEmailDocumentUpdated"
                               @componentAdded="onComponentAdded" />
            </div>

            <SidePanel v-if="!ltr"
                       v-model:buttonGlobalProps="buttonGlobalProps"
                       v-model:selectedComponentElement="selectedComponentElement"
                       :emailDocument="emailDocument"
                       :imageComponentBinaryFileTypeGuid="imageComponentBinaryFileTypeGuid"
                       :ltr="ltr"
                       :mergeFields="mergeFields"
                       :recipientPersonIds="recipientPersonIds"
                       :shortLinkCheckToken="shortLinkCheckToken"
                       :shortLinkGetPageId="shortLinkGetPageId"
                       :shortLinkSites="shortLinkSites"
                       :shortLinkTokenMinLength="shortLinkTokenMinLength"
                       :usageType="usageType"
                       :videoProviderNames="videoProviderNames"
                       @cloneComponent="onCloneComponent"
                       @completeComponent="onCompleteComponent"
                       @componentTypeDragStart="onComponentTypeDragStart"
                       @componentTypeDragEnd="onComponentTypeDragEnd"
                       @deleteComponent="onDeleteComponent"
                       @replaceComponent="onReplaceComponent">
                <template v-if="$slots.bodySettingsPrepend" #bodySettingsPrepend>
                    <slot name="bodySettingsPrepend"></slot>
                </template>
            </SidePanel>
        </div>
    </div>
</template>

<style scoped>
/* #region Email Editor Container */
.email-editor-wrapper {
    display: flex;
    flex-direction: column;
    height: 100%;
}

/* #endregion Email Editor Container */

/* #region Email Editor */
.email-editor {
    display: flex;
    flex-grow: 1;
    background-color: var(--color-interface-softest);
    overflow: hidden;
}

.email-designer-container {
    flex-grow: 1;
    flex-basis: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color-interface-soft);
}

/* #endregion Email Editor */
</style>

<script setup lang="ts">
    import { PropType, ref, watch } from "vue";
    import EmailDesigner from "./emailDesigner.partial.obs";
    import SidePanel from "./sidePanel.partial.obs";
    import { ButtonGlobalProps, CloneComponentRequest, CompleteComponentRequest, ComponentTypeDragEndRequest, ComponentTypeDragStartRequest, ComponentTypeName, DeleteComponentRequest, ReplaceComponentRequest } from "./types.partial";
    import { GetHtmlRequest, UsageType } from "./types";
    import { BinaryFiletype } from "@Obsidian/SystemGuids/binaryFiletype";
    import { Guid } from "@Obsidian/Types";
    import { ListItemBag } from "@Obsidian/ViewModels/Utility/listItemBag";
    import { useSecurityGrantToken } from "@Obsidian/Utility/block";
    import { EmailEditorApi, provideApi } from "./api";
    import { createButtonComponentAdapter } from "./utils.partial";
    import { Enumerable } from "@Obsidian/Utility/linq";
    import { isHTMLElement } from "@Obsidian/Utility/dom";

    defineProps({
        html: {
            type: String as PropType<string>,
            required: true
        },

        emailEditorCssClass: {
            type: String as PropType<string | null | undefined>
        },

        getHtmlRequest: {
            type: Object as PropType<GetHtmlRequest | null | undefined>,
            required: false
        },

        imageComponentBinaryFileTypeGuid: {
            type: String as PropType<Guid>,
            default: BinaryFiletype.CommunicationImage
        },

        disabled: {
            type: Boolean as PropType<boolean>,
            default: false
        },

        ltr: {
            type: Boolean as PropType<boolean>,
            default: false
        },

        /** Paragraph & Lava components - the merge fields available for selection. */
        mergeFields: {
            type: Object as PropType<string[] | undefined>,
            required: true
        },

        /** RSVP component - the recipients who should be registered in the RSVP component when the register button is clicked. */
        recipientPersonIds: {
            type: Object as PropType<number[] | null | undefined>,
            required: true
        },

        shortLinkCheckToken: {
            type: Object as PropType<((token: string, siteId: number) => Promise<string>) | null | undefined>
        },

        shortLinkGetPageId: {
            type: Object as PropType<((pageGuid: Guid) => Promise<number | null | undefined>) | null | undefined>
        },

        shortLinkSites: {
            type: Array as PropType<ListItemBag[] | null | undefined>
        },

        shortLinkTokenMinLength: {
            type: Number as PropType<number | null | undefined>
        },

        usageType: {
            type: String as PropType<UsageType>,
            default: "email" as const
        },

        /** Video component - the video provider names used to add context to the Source Video URL help text. */
        videoProviderNames: {
            type: Object as PropType<string[] | null | undefined>,
            required: true
        }
    });

    const emit = defineEmits<{
        (e: "update:communicationTemplateGuid", value: Guid | null | undefined): void;
        (e: "emailDocumentUpdated", document: Document): void;
    }>();

    defineExpose({
        getApi
    });

    const securityGrantToken = useSecurityGrantToken();
    const api = new EmailEditorApi({ securityGrantToken });
    provideApi(api);

    const buttonAdapter = createButtonComponentAdapter();

    // #region Values

    const selectedComponentElement = ref<HTMLElement | null | undefined>();
    const emailDocument = ref<Document | null | undefined>();

    const cloneComponentRequest = ref<CloneComponentRequest | null | undefined>();
    const completeComponentRequest = ref<CompleteComponentRequest | null | undefined>();
    const deleteComponentRequest = ref<DeleteComponentRequest | null | undefined>();
    const componentTypeDragStartRequest = ref<ComponentTypeDragStartRequest | null | undefined>();
    const componentTypeDragEndRequest = ref<ComponentTypeDragEndRequest | null | undefined>();
    const replaceComponentRequest = ref<ReplaceComponentRequest | null | undefined>();

    const buttonGlobalProps = ref<ButtonGlobalProps>({} as ButtonGlobalProps);

    // #endregion

    // #region Functions

    /**
     * Gets the API for the email editor.
     *
     * @returns The API for the email editor. This is used to communicate with server on behalf of the email editor.
     */
    function getApi(): EmailEditorApi {
        return api;
    }

    // #endregion

    // #region Event Handlers

    function onComponentTypeDragStart(event: ComponentTypeDragStartRequest): void {
        componentTypeDragStartRequest.value = event;
    }

    function onComponentTypeDragEnd(event: ComponentTypeDragEndRequest): void {
        componentTypeDragEndRequest.value = event;
    }

    function onCloneComponent(event: CloneComponentRequest): void {
        cloneComponentRequest.value = event;
    }

    function onReplaceComponent(event: ReplaceComponentRequest): void {
        replaceComponentRequest.value = event;
    }

    function onCompleteComponent(event: CompleteComponentRequest): void {
        completeComponentRequest.value = event;
    }

    function onDeleteComponent(event: DeleteComponentRequest): void {
        deleteComponentRequest.value = event;
    }

    function onEmailDocumentUpdated(eventArgs: { emailDocument: Document, areGlobalDefaultsRequired: boolean }): void {
        const { emailDocument: emailDoc, areGlobalDefaultsRequired } = eventArgs;

        // Migrate all button components in the document.
        Enumerable
            .from(emailDoc.querySelectorAll(".component-button"))
            .ofType<HTMLElement>((el): el is HTMLElement => isHTMLElement(el))
            .forEach((componentElement) => {
                buttonAdapter.migrateComponent(emailDoc, componentElement);
            });

        // Initialize global button props or migrate existing ones.
        if (areGlobalDefaultsRequired || buttonAdapter.areGlobalDefaultsNeeded(emailDoc)) {
            // This occurs for a new document
            // or one that did not previously have global button props
            // and needs the default values.
            buttonGlobalProps.value = buttonAdapter.getDefaultGlobalProps();
            buttonAdapter.writeGlobalProps(emailDoc, buttonGlobalProps.value);
        }
        else {
            // This occurs when loading an existing document
            // that already has global button props
            // and may need to be migrated.
            buttonAdapter.migrateGlobalProps(emailDoc);
            buttonGlobalProps.value = buttonAdapter.readGlobalProps(emailDoc);
        }

        // Update the email document reference after migrations in case setting it triggers reactivity.
        emailDocument.value = emailDoc;
        emit("emailDocumentUpdated", emailDoc);
    }

    function onComponentAdded(event: { componentTypeName: ComponentTypeName; componentElement: HTMLElement }): void {
        if (event.componentTypeName === "button" && emailDocument.value) {
            // Apply global props.
            buttonAdapter.writeGlobalProps(emailDocument.value, buttonGlobalProps.value);
        }
    }

    // #endregion Event Handlers

    // #region Watchers

    watch(buttonGlobalProps, (newValue) => {
        if (emailDocument.value) {
            buttonAdapter.writeGlobalProps(emailDocument.value, newValue);
        }
    });

    // #endregion Watchers
</script>
