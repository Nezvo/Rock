<!-- Copyright by the Spark Development Network; Licensed under the Rock Community License -->
<template>
    <div ref="cellElement"
         class="grid-cell"
         :class="[additionalItemClass, columnTypeClass]"
         :style="additionalCellStyles"
         :title="tooltipContent"
         @click="onClick"
         role="gridcell">
        <component :is="props.column.formatComponent"
                   :row="props.row"
                   :column="props.column"
                   :grid="props.grid" />
    </div>
</template>

<script setup lang="ts">
    import { PropType, computed, onBeforeUnmount, onMounted, ref } from "vue";
    import { ColumnDefinition, IGridState } from "@Obsidian/Types/Controls/grid";
    import { getColumnStyles } from "@Obsidian/Core/Controls/grid";
    import { escapeHtml } from "@Obsidian/Utility/stringUtils";
    import { destroyTooltip, tooltip } from "@Obsidian/Utility/tooltip";

    const props = defineProps({
        /** The column definition of this cell. */
        column: {
            type: Object as PropType<ColumnDefinition>,
            required: true
        },

        /** The data row that contains the value to be displayed. */
        row: {
            type: Object as PropType<Record<string, unknown>>,
            required: true
        },

        /** This grid this cell belongs to. */
        grid: {
            type: Object as PropType<IGridState>,
            required: true
        },

        /** True if this cell is selectable. */
        isSelectable: {
            type: Boolean as PropType<boolean>,
            default: false
        }
    });

    const emit = defineEmits<{
        (e: "click"): void
    }>();

    const cellElement = ref<HTMLElement>();
    const tooltipContent = getTooltipContent();

    /** Contains any additional CSS classes for the td element. */
    const additionalItemClass = computed((): string => {
        let classes = props.column.itemClass ?? "";

        if (["sm", "md", "lg", "xl"].includes(props.column.visiblePriority)) {
            // We don't have support for lg just yet, but it's coming.
            if (props.column.visiblePriority === "xl") {
                classes += ` d-none d-lg-flex`;
            }
            else {
                classes += ` d-none d-${props.column.visiblePriority}-flex`;
            }
        }

        if (props.column.wrapped) {
            classes += " grid-wrapcell";
        }

        return classes.trim();
    });

    /** Contains the additional styles to be applied to the cell. */
    const additionalCellStyles = computed((): Record<string, string> => {
        const styles: Record<string, string> = {
            ...getColumnStyles(props.column)
        };

        return styles;
    });

    // create a computed property that will set the column type class to the correct value
    const columnTypeClass = computed((): string => {
        return `grid-cell-${props.column.columnType}`;
    });

    /**
     * Contains `true` if this cell should be considered selectable by the
     * individual and emit the clicked event.
     */
    const isSelectable = computed((): boolean => {
        return props.isSelectable && !props.column.name.startsWith("__");
    });

    /**
     * Gets the HTML content for the tooltip. If tooltipHtml is not set then
     * then the tooltip text will be HTML escaped.
     *
     * @returns The string of HTML content for the tooltip.
     */
    function getTooltipContent(): string | undefined {
        if (!props.column.tooltip) {
            return undefined;
        }

        const tooltipText = typeof props.column.tooltip === "string"
            ? props.column.tooltip
            : props.column.tooltip(props.row, props.column, props.grid);

        if (!tooltipText) {
            return undefined;
        }

        return props.column.tooltipHtml
            ? escapeHtml(tooltipText)
            : tooltipText;
    }

    /**
     * Called when the cell has been clicked if selection has been enabled.
     */
    function onClick(ev: Event): void {
        if (!isSelectable.value) {
            return;
        }

        ev.stopPropagation();

        if (props.isSelectable) {
            emit("click");
        }
    }

    onMounted(() => {
        if (cellElement.value && tooltipContent) {
            tooltip(cellElement.value, {
                html: true,
                delay: {
                    show: 500,
                    hide: 100
                }
            });
        }
    });

    onBeforeUnmount(() => {
        if (cellElement.value) {
            destroyTooltip(cellElement.value);
        }
    });
</script>
