<!-- Copyright by the Spark Development Network; Licensed under the Rock Community License -->
<template>
    <NotificationBox v-if="errorMessage" :text="errorMessage" :alertType="AlertType.Danger" />
    <Panel title="Lava Shortcodes"
           titleIconCssClass="ti ti-cube"
           type="block"
           :headerSecondaryActions="secondaryActions"
           v-model:quickFilterValue="quickFilterValue">
        <template #headerActions>
            <div class="action">
                <ButtonDropDownList v-model="filteredCategory" :items="categoryItems" :blankValue="blankCategory" />
            </div>
            <button v-if="canEdit"
                    type="button"
                    class="btn btn-panel-action btn-add"
                    @click="onAddClick">
                <i class="ti ti-square-plus"></i>
            </button>
        </template>

        <NotificationBox v-if="!filteredLavaShortcodes.length" :alertType="AlertType.Info">
            No shortcodes found matching the current filters.
        </NotificationBox>

        <div class="lava-shortcode-list-items">
            <ContentSectionContainer sidebar>
                <ContentSection v-for="(shortcode, index) in filteredLavaShortcodes"
                                :key="`${index}-${shortcode.guid}`"
                                :title="shortcode.name ?? ''"
                                :isCollapsed="true"
                                :order="index">
                    <template v-if="shortcode.description" #description>
                        {{ shortcode.description }}
                    </template>

                    <template #headerActions>
                        <span v-if="!shortcode.isActive" class="label label-warning">Inactive</span>
                        <span v-if="shortcode.isSystem" class="label label-default">System</span>
                        <template v-if="shortcode.categories?.length">
                            <span v-for="category in shortcode.categories" class="label label-info">
                                {{ category.text }}
                            </span>
                        </template>

                        <button type="button"
                                class="btn btn-action"
                                :disabled="!isEditEnabled(shortcode)"
                                @click.prevent.stop="onEditClick(shortcode)">
                            <i class="ti ti-pencil"></i>
                        </button>

                        <DropDownMenu :items="getDropDownMenuItems(shortcode)"
                                      align="right"
                                      anchorButtonCssClass="btn-minimal" />
                    </template>

                    <template #default>
                        <ContentStack>
                            <span v-html="shortcode.documentation"></span>

                            <div class="lava-shortcode-edit-disabled-notification-box">
                                <NotificationBox v-if="isNullOrWhiteSpace(shortcode.idKey) && shortcode.isSystem" alertType="info">
                                    This shortcode is defined in code (versus being stored in the database) and therefore can not be modified.
                                </NotificationBox>
                            </div>
                        </ContentStack>
                    </template>
                </ContentSection>
            </ContentSectionContainer>
        </div>
    </Panel>
</template>

<style scoped>
.lava-shortcode-edit-disabled-notification-box {
    margin-top: var(--spacing-large);
}
</style>

<script setup lang="ts">
    import { onConfigurationValuesChanged, useConfigurationValues, useInvokeBlockAction, useReloadBlock } from "@Obsidian/Utility/block";
    import { confirmDelete } from "@Obsidian/Utility/dialogs";
    import ContentSectionContainer from "@Obsidian/Controls/contentSectionContainer.obs";
    import ContentSection from "@Obsidian/Controls/contentSection.obs";
    import ContentStack from "@Obsidian/Controls/contentStack.obs";
    import DropDownMenu from "@Obsidian/Controls/dropDownMenu.obs";
    import NotificationBox from "@Obsidian/Controls/notificationBox.obs";
    import ButtonDropDownList from "@Obsidian/Controls/buttonDropDownList.obs";
    import { LavaShortcodeListBox } from "@Obsidian/ViewModels/Blocks/Cms/LavaShortcodeList/lavaShortcodeListBox";
    import { computed, ref } from "vue";
    import Panel from "@Obsidian/Controls/panel.obs";
    import { MenuAction } from "@Obsidian/Types/Controls/dropDownMenu";
    import { PanelAction } from "@Obsidian/Types/Controls/panelAction";
    import { LavaShortcodeBag } from "@Obsidian/ViewModels/Blocks/Cms/LavaShortcodeDetail/lavaShortcodeBag";
    import { isNullOrWhiteSpace } from "@Obsidian/Utility/stringUtils";
    import { Enumerable } from "@Obsidian/Utility/linq";
    import { ListItemBag } from "@Obsidian/ViewModels/Utility/listItemBag";
    import { AlertType } from "@Obsidian/Enums/Controls/alertType";

    const box = useConfigurationValues<LavaShortcodeListBox>();
    const invokeBlockAction = useInvokeBlockAction();
    onConfigurationValuesChanged(useReloadBlock());

    // #region Values

    const errorMessage = ref("");
    const blankCategory = ref("All Shortcodes");
    const canEdit = ref(box.userCanEdit ?? false);
    const categories = ref(box.categories ?? []);
    const detailPage = ref(box.detailPage ?? "");
    const filteredCategory = ref(blankCategory.value);
    const includeInactive = ref(false);
    const lavaShortcodes = ref(box.lavaShortcodes.sort((a, b) => (a.name ?? "").localeCompare(b.name ?? "")));
    const quickFilterValue = ref("");

    // #endregion Values

    // #region Computed Values

    /**
     * Gets the list of secondary action items to be included in the panel.
     */
    const secondaryActions = computed((): PanelAction[] => {
        const actions: PanelAction[] = [];

        if (includeInactive.value) {
            actions.push({
                title: "Hide Inactive",
                iconCssClass: "ti ti-eye-off",
                type: "default",
                handler: (_: Event) => {
                    includeInactive.value = false;
                }
            });
        }
        else {
            actions.push({
                title: "Show Inactive",
                iconCssClass: "ti ti-eye",
                type: "default",
                handler: (_: Event) => {
                    includeInactive.value = true;
                }
            });
        }

        return actions;
    });

    /**
     * Gets the list of category items including a blank option for all shortcodes.
    */
    const categoryItems = computed((): ListItemBag[] => {
        const items: ListItemBag[] = [
            { text: blankCategory.value, value: blankCategory.value }
        ];

        categories.value.forEach(c => {
            items.push({ text: c.text, value: c.value });
        });

        return items;
    });

    /**
     * Gets the lava shortcodes based on the selected category and include inactive filters.
     * @returns The filtered lava shortcodes.
     */
    const filteredLavaShortcodes = computed((): LavaShortcodeBag[] => {
        const hasCategoryFilter = filteredCategory.value !== blankCategory.value;

        return Enumerable
            .from(
                lavaShortcodes.value.filter(l => {
                    return (includeInactive.value || l.isActive)
                        && (
                            !hasCategoryFilter
                            || l.categories?.some(
                                c => c.value === filteredCategory.value
                            )
                        )
                        && (
                            isNullOrWhiteSpace(quickFilterValue.value)
                            || (
                                (l.name ?? "").toUpperCase().includes(
                                    quickFilterValue.value.toUpperCase()
                                )
                                || (l.description ?? "").toUpperCase().includes(
                                    quickFilterValue.value.toUpperCase()
                                )
                            )
                        );
                })
            )
            .orderBy(l => l.name ?? "")
            .toArray();
    });

    // #endregion Computed Values

    // #region Functions

    /**
     * Gets whether this shortcode may be edited.
     * @param lavaShortcode The lava shortcode.
     * @returns Whether this shortcode may be edited
     */
    function isEditEnabled(lavaShortcode: LavaShortcodeBag): boolean {
        return canEdit.value && !isNullOrWhiteSpace(lavaShortcode.idKey);
    }

    /**
     * Gets whether this shortcode may be deleted.
     * @param lavaShortcode The lava shortcode.
     * @returns Whether this shortcode may be deleted.
     */
    function isDeleteEnabled(lavaShortcode: LavaShortcodeBag): boolean {
        return isEditEnabled(lavaShortcode) && !lavaShortcode.isSystem;
    }

    /**
     * Gets the drop down menu items for the lava shortcode.
     * @param lavaShortCode The lava shortcode.
     * @returns The drop down menu items for the lava shortcode.
     */
    function getDropDownMenuItems(lavaShortCode: LavaShortcodeBag): MenuAction[] {
        const canDelete = isDeleteEnabled(lavaShortCode);

        return [
            {
                iconCssClass: "ti ti-x",
                title: "Delete",
                type: canDelete ? "danger" : "default",
                handler: () => onDeleteClick(lavaShortCode),
                disabled: !canDelete
            }
        ];
    }

    // #endregion Functions

    // #region Event Handlers

    /** Navigates to the add lava shortcode page. */
    function onAddClick(): void {
        if (detailPage.value) {
            window.location.href = detailPage.value.replace("((Key))", "0");
        }
    }

    /**
     * Navigates to the edit lava shortcode page.
     * @param lavaShortcode The lava shortcode to edit.
     */
    function onEditClick(lavaShortcode: LavaShortcodeBag): void {
        if (detailPage.value) {
            const queryStrings = "?autoEdit=true&returnUrl=" + encodeURIComponent(window.location.href);
            window.location.href = detailPage.value.replace("((Key))", lavaShortcode.idKey ?? "") + queryStrings;
        }
    }

    /**
     * Deletes a lava shortcode.
     * @param lavaShortcode The lava shortcode to delete.
     */
    async function onDeleteClick(lavaShortcode: LavaShortcodeBag): Promise<void> {
        const key = lavaShortcode.idKey ?? "";

        if (key && await confirmDelete("LavaShortcode")) {
            const result = await invokeBlockAction("Delete", { key });

            if (result.isSuccess) {
                const index = lavaShortcodes.value.findIndex(l => l.idKey === key);
                if (index > -1) {
                    lavaShortcodes.value.splice(index, 1);
                }
            }
            else {
                errorMessage.value = result.errorMessage ?? "An error occurred while deleting the lava shortcode.";
            }
        }
    }

    // #endregion Event Handlers

</script>
