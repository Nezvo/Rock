<!-- Copyright by the Spark Development Network; Licensed under the Rock Community License -->
<template>
    <Modal v-model="isVisible" title="Link To Form" saveText="Close" @save="onClose" :isSaveButtonDisabled="false">
        <div class="well no-border">
            <h4 class="mb-1">Select a Page For Form Link</h4>
            <p class="text-muted text-sm">Choose a page from the list below to generate a link for the form. Once
                selected, you can copy and use the link as needed.</p>
        </div>

        <div v-if="isLoading" class="text-center">
            <LoadingIndicator />
        </div>
        <div v-else-if="links.length === 0" class="text-center">
            <p>No pages available for linking.</p>
        </div>
        <DisplayCardContainer v-else>
            <DisplayCard v-for="page in links" :key="page.pageId" :title="page.siteAndPage"
                         :description="page.friendlyRouteUrl">
                <template #actions>
                    <CopyButton :value="page.routeUrl ?? ''"><i class="ti ti-clipboard"></i> Copy Link</CopyButton>
                </template>
            </DisplayCard>
        </DisplayCardContainer>
    </Modal>
</template>

<script setup lang="ts">
    import Modal from "@Obsidian/Controls/modal.obs";
    import CopyButton from "@Obsidian/Controls/copyButton.obs";
    import LoadingIndicator from "@Obsidian/Controls/loadingIndicator.obs";
    import DisplayCardContainer from "@Obsidian/Controls/displayCardContainer.obs";
    import DisplayCard from "@Obsidian/Controls/displayCard.obs";
    import { PropType, ref, watch } from "vue";
    import { useVModelPassthrough } from "@Obsidian/Utility/component";
    import { useInvokeBlockAction } from "@Obsidian/Utility/block";
    import { FormListLinkToFormBag } from "@Obsidian/ViewModels/Blocks/WorkFlow/FormBuilder/FormList/formListLinkToFormBag";
    import { Guid } from "@Obsidian/Types";

    const props = defineProps({
        modelValue: {
            type: Boolean as PropType<boolean>,
            required: true
        },
        workflowTypeGuid: {
            type: String as PropType<Guid | null>,
            default: null
        }
    });

    const emit = defineEmits<{
        (e: "update:modelValue", value: boolean): void;
    }>();

    const isVisible = useVModelPassthrough(props, "modelValue", emit);
    const invokeBlockAction = useInvokeBlockAction();
    const links = ref<FormListLinkToFormBag[]>([]);
    const isLoading = ref(false);

    /**
     * Fetches the links for the specified workflow type.
     */
    async function fetchLinks(): Promise<void> {
        if (!props.workflowTypeGuid) {
            return;
        }

        isLoading.value = true;
        const result = await invokeBlockAction<FormListLinkToFormBag[]>("GetFormLinks", { workflowTypeGuid: props.workflowTypeGuid });
        isLoading.value = false;

        if (result.isSuccess && result.data) {
            links.value = result.data;
        }
        else {
            links.value = [];
        }
    }

    /**
     * Event handler for the "Close" button.
     * Closes the modal.
     */
    function onClose(): void {
        isVisible.value = false;
    }

    // Watch for changes to the modelValue (visibility) and fetch links when it becomes visible.
    watch(() => props.modelValue, (val) => {
        if (val) {
            fetchLinks();
        }
    });
</script>
